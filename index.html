<!DOCTYPE html>
<html>
  <head>
    <title>Code Coverage for dd-trace-cpp</title>
  </head>
  <body>
    <h1>Code Coverage for dd-trace-cpp</h1>
    <style>
    a {
      text-decoration: none;
    }
    </style>
    <script>
      const sortByStringKey = (array, getKey) =>
        array.sort((left, right) =>
          getKey(left).localeCompare(getKey(right)));

      const decodeHex = hex_string => hex_string.replaceAll(/../g, hex_byte => decodeURIComponent(`%${hex_byte}`))

      function parse_name(name) {
        // name is like: 2023-09-20T12:10:14.000Z-45c3c05-lines:2651:2728:97.2-funcs:510:534:95.5-64617669642e676f66667265646f2f70726574746965722d636f766572616765
        // The ugly part at the end is the hex encoding of
        // "david.goffredo/prettier-coverage".
        // I couldn't use URL encoding because URL-encoded forward slashes cause
        // 404 in GitHub pages (the shame).
        const regex = /^(....-..-..T..:..:..\....Z)-(.......)-lines:(\d+):(\d+):([0-9.]+)-funcs:(\d+):(\d+):([0-9.]+)-(.*)$/;

        let [date, commit, lines_numerator, lines_denominator, lines_percent, funcs_numerator, funcs_denominator, funcs_percent, branch] = name.match(regex).slice(1);

        date = new Date(date);
        branch = decodeHex(branch);

        return {name, date, commit, lines_numerator, lines_denominator, lines_percent, funcs_numerator, funcs_denominator, funcs_percent, branch};
      }

      (async () => {
        const response = await fetch('https://api.github.com/repos/DataDog/dd-trace-cpp-coverage/contents/?ref=gh-pages');
        const data = await response.json();
        const files = [];

        const ignore = file => file.type !== 'dir' || file.name == 'dummy';

        for (let file of data) {
          if (ignore(file)) continue;
          files.push({
            name: file.name,
            path: file.path,
            ...parse_name(file.name)
          });
          // console.log(file);
        }

        sortByStringKey(files, file => file.name);
        files.reverse();

        const table = document.createElement('table');
        table.setAttribute('cellspacing', '10px');
        const tr = document.createElement('tr');
        ['Commit Date', 'Commit', 'Branch', 'Coverage'].forEach(heading => {
          const th = document.createElement('th');
          th.textContent = heading;
          tr.appendChild(th);
        });
        table.appendChild(tr);

        for (let file of files) {
          const tr = document.createElement('tr');

          let td = document.createElement('td');
          td.textContent = file.date.toISOString().replace('T', ' ').replace('Z', ' UTC').replace(/\.\d+/, '');
          tr.appendChild(td);

          td = document.createElement('td');
          let a = document.createElement('a');
          a.setAttribute('href', `https://github.com/DataDog/dd-trace-cpp/commit/${file.commit}`);
          a.textContent = file.commit;
          td.appendChild(a);
          tr.appendChild(td);

          td = document.createElement('td');
          td.textContent = file.branch;
          tr.appendChild(td);

          td = document.createElement('td');
          a = document.createElement('a');
          a.setAttribute('href', file.path);
          a.textContent = `${file.lines_percent}% lines, ${file.funcs_percent}% functions`;
          td.appendChild(a);
          tr.appendChild(td);

          table.appendChild(tr);
        }

        document.getElementsByTagName('body')[0].appendChild(table);
      })()
    </script>
  <body>
</html>
